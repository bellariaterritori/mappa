<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Territori Bellaria</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; margin: 0; }
        body { margin: 0; font-family: sans-serif; }
        .info-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <b>Mappa Territori</b><br>
        <small>Clicca su un'area per il link</small>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inizializziamo la mappa (la posizione iniziale verrà sovrascritta dallo zoom automatico)
        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const urlParams = new URLSearchParams(window.location.search);
        const areaCercata = urlParams.get('area');

        fetch('Prova.json')
            .then(response => response.json())
            .then(data => {
                const geoJsonLayer = L.geoJSON(data, {
                    style: function(feature) {
                        const isSelected = (areaCercata && feature.properties.name === areaCercata);
                        return {
                            color: isSelected ? "red" : "#3388ff",
                            weight: isSelected ? 4 : 2,
                            fillOpacity: isSelected ? 0.6 : 0.2
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        const nome = feature.properties.name || "Area senza nome";
                        layer.bindPopup(`
                            <b>${nome}</b><br>
                            <button onclick="copiaLink('${nome}')">Copia link area</button>
                        `);

                        // Se è l'area del link, facciamo zoom specifico qui
                        if (areaCercata && feature.properties.name === areaCercata) {
                            setTimeout(() => {
                                map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                                layer.openPopup();
                            }, 500);
                        }
                    }
                }).addTo(map);

                // ZOOM AUTOMATICO GENERALE
                // Se NON c'è un'area specifica nel link, inquadra tutti i poligoni insieme
                if (!areaCercata) {
                    const bounds = geoJsonLayer.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [30, 30] });
                    }
                }
            })
            .catch(err => console.error("Errore:", err));

        function copiaLink(nomeArea) {
            const link = window.location.origin + window.location.pathname + "?area=" + encodeURIComponent(nomeArea);
            navigator.clipboard.writeText(link).then(() => {
                alert("Link copiato! Invia questo per mostrare l'area: " + nomeArea);
            });
        }
    </script>
</body>
</html>